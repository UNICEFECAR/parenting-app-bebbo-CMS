<?php

/**
 * @file
 * Language Visibility Control module.
 */

use Drupal\field\Entity\FieldConfig;
use Drupal\Core\Form\FormStateInterface;
use Drupal\group\Entity\Group;

/**
 * Implements hook_form_alter().
 */
function language_visibility_control_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Alter the country group form to add language visibility controls.
  if ($form_id === 'group_country_edit_form' || $form_id === 'group_country_add_form') {
    $group = $form_state->getFormObject()->getEntity();

    // Attach JS behavior and language data.
    $form['#attached']['library'][] = 'language_visibility_control/admin';

    // Load and prepare language options for JS.
    $all_languages = \Drupal::languageManager()->getLanguages();
    $language_options = array_map(function ($language) {
      return $language->getName();
    }, $all_languages);

    $form['#attached']['drupalSettings']['languageVisibilityControl']['availableLanguages'] = $language_options;

    // Always add the language visibility fieldset.
    $form['language_visibility'] = [
      '#type' => 'fieldset',
      '#title' => t('Language Visibility in Mobile App'),
      '#weight' => 50,
      '#tree' => TRUE,
      '#prefix' => '<div id="language-visibility-wrapper">',
      '#suffix' => '</div>',
      '#attributes' => [
        'data-drupal-selector' => 'edit-language-visibility',
      ],
    ];

    // Always add the fieldset description as a separate element.
    $form['language_visibility']['fieldset_description'] = [
      '#type' => 'markup',
      '#markup' => '<div class="language-visibility-description">Control which of the selected languages above should appear in the mobile app API. Languages not checked here can still be edited by users but will not be visible in the mobile app.</div>',
      '#weight' => -90,
      '#attributes' => [],
    ];

    // Modify the existing language field to add visibility controls.
    if (isset($form['field_language'])) {
      // Add description to the language field.
      $form['field_language']['widget']['#description'] = t('Select languages for this country. Use the "Language Visibility" section below to control which languages appear in the mobile app.');

      // Update the fieldset weight to be relative to the language field.
      $form['language_visibility']['#weight'] = $form['field_language']['#weight'] + 1;

      // Get currently selected languages.
      $current_languages = _language_visibility_control_get_selected_languages($form_state, $group);

      // Get currently visible languages.
      $visible_languages = _language_visibility_control_get_visible_languages($form_state, $group);

      // Add checkboxes only for currently selected languages.
      foreach (array_unique($current_languages) as $langcode) {
        if (isset($all_languages[$langcode])) {
          $language_name = $all_languages[$langcode]->getName();
          $form['language_visibility'][$langcode] = [
            '#type' => 'checkbox',
            '#title' => t('@language (@code)', [
              '@language' => $language_name,
              '@code' => $langcode,
            ]),
            '#default_value' => in_array($langcode, $visible_languages),
          ];
        }
      }

      // Add help text if no languages are selected.
      if (empty($current_languages)) {
        $form['language_visibility']['help'] = [
          '#type' => 'markup',
          '#markup' => '<p><em>' . t('Select languages above to configure their visibility in the mobile app.') . '</em></p>',
        ];
      }

      // Add custom validation and submit handlers.
      $form['#validate'][] = 'language_visibility_control_group_form_validate';

      // Add submit handler BEFORE the main entity save.
      array_unshift($form['actions']['submit']['#submit'], 'language_visibility_control_group_form_submit');
    }
  }
}

/**
 * Custom validation handler for group forms.
 */
function language_visibility_control_group_form_validate($form, FormStateInterface $form_state) {
  // Simple validation - just ensure we have valid data.
  $language_visibility = $form_state->getValue('language_visibility');

  if ($language_visibility && !is_array($language_visibility)) {
    $form_state->setErrorByName('language_visibility', t('Invalid language visibility data.'));
  }
}

/**
 * Custom submit handler for group forms.
 */
function language_visibility_control_group_form_submit($form, FormStateInterface $form_state) {
  // Prefer structured values from Form API when available.
  $language_visibility = $form_state->getValue('language_visibility');
  // Fall back to raw user input.
  if (empty($language_visibility)) {
    $user_input = $form_state->getUserInput();
    if (isset($user_input['language_visibility']) && is_array($user_input['language_visibility'])) {
      $language_visibility = $user_input['language_visibility'];
    }
  }

  if (!empty($language_visibility)) {
    $visible_langcodes = [];
    foreach ($language_visibility as $langcode => $visible) {
      // Accept truthy values: '1', 1, 'on', true.
      if (is_string($langcode) && ($visible === 1 || $visible === '1' || $visible === 'on' || $visible === TRUE)) {
        $visible_langcodes[] = $langcode;
      }
    }

    // Get selected languages to validate against.
    $group = $form_state->getFormObject()->getEntity();
    $selected_country_langcodes = _language_visibility_control_get_selected_languages($form_state, $group);

    // Filter visible languages to only include selected ones.
    $valid_visible_langcodes = array_values(array_intersect($visible_langcodes, $selected_country_langcodes));

    if ($group && $group->hasField('field_language_visibility_in_app') && !empty($valid_visible_langcodes)) {
      $visible_languages = array_map(function ($code) {
        return ['value' => $code];
      }, $valid_visible_langcodes);

      $group->set('field_language_visibility_in_app', $visible_languages);
    }
  }
}

/**
 * Helper function to filter languages based on visibility settings.
 *
 * This function is called from the custom serializer.
 */
function language_visibility_control_filter_languages($languages, $group_id) {
  $group = Group::load($group_id);
  if (!$group) {
    return $languages;
  }

  $service = \Drupal::service('language_visibility_control.service');
  return $service->filterLanguageDataForApi($languages, $group);
}

/**
 * Helper function to get selected languages from form state or entity.
 */
function _language_visibility_control_get_selected_languages($form_state, $group) {
  $current_languages = [];
  $user_input = $form_state->getUserInput();

  // Extract languages from user input.
  if (isset($user_input['field_language'])) {
    $input_val = $user_input['field_language'];

    if (is_array($input_val)) {
      $current_languages = array_filter(array_map(function ($item) {
        if (is_array($item) && !empty($item['value'])) {
          return $item['value'];
        }
        elseif (is_string($item) && $item !== '' && $item !== '_none') {
          return $item;
        }
        return NULL;
      }, $input_val));
    }
    elseif (is_string($input_val) && $input_val !== '' && $input_val !== '_none') {
      $current_languages[] = $input_val;
    }
  }

  // Fallback to entity values if no user input.
  if (empty($current_languages) && $group && $group->hasField('field_language') && !$group->get('field_language')->isEmpty()) {
    $current_languages = array_filter(array_column($group->get('field_language')->getValue(), 'value'));
  }

  return array_unique($current_languages);
}

/**
 * Helper function to get visible languages from form state or entity.
 */
function _language_visibility_control_get_visible_languages($form_state, $group) {
  $visible_languages = [];
  $user_input = $form_state->getUserInput();

  // Extract from user input.
  if (isset($user_input['language_visibility']) && is_array($user_input['language_visibility'])) {
    $excluded_keys = ['help_message', 'help', 'fieldset_description'];

    $visible_languages = array_keys(array_filter($user_input['language_visibility'], function ($checked, $langcode) use ($excluded_keys) {
      return !in_array($langcode, $excluded_keys) &&
             !str_ends_with($langcode, '_description') &&
             !empty($checked);
    }, ARRAY_FILTER_USE_BOTH));
  }
  // Fallback to entity values.
  elseif ($group && $group->hasField('field_language_visibility_in_app') && !$group->get('field_language_visibility_in_app')->isEmpty()) {
    $visible_languages = array_filter(array_column($group->get('field_language_visibility_in_app')->getValue(), 'value'));
  }

  return $visible_languages;
}

/**
 * Implements hook_help().
 */
function language_visibility_control_help($route_name, $route_match) {
  switch ($route_name) {
    case 'help.page.language_visibility_control':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Language Visibility Control module allows you to control which languages appear in the mobile app API for country groups.') . '</p>';

      // Check if field exists.
      $field_config = FieldConfig::loadByName('group', 'country', 'field_language_visibility_in_app');
      if ($field_config) {
        $output .= '<p><strong>' . t('Status: Field is properly configured.') . '</strong></p>';
      }
      else {
        $output .= '<p><strong style="color: red;">' . t('Warning: Field is not configured. Please reinstall the module.') . '</strong></p>';
      }

      return $output;
  }
}
