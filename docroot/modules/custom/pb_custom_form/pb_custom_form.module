<?php

/**
 * @file
 * It contains custom field module.
 */

use Drupal\Core\Url;
use Drupal\node\NodeInterface;
use Drupal\taxonomy\Entity\Term;
use Drupal\views\ViewExecutable;
use Drupal\Core\Form\FormStateInterface;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Symfony\Component\Routing\Exception\RouteNotFoundException;

/**
 * AJAX callback to filter Subcategory options.
 */
function pb_custom_form_dynamic_category_ajax_callback(array &$form, FormStateInterface $form_state) {
  $selected_category = $form_state->getValue(['field_content_category', 0, 'target_id']);
  // Logic to fetch subcategory options based on the selected category.
  $subcategory_options = pb_custom_form_get_subcategory_options($selected_category);
  // Update the options of the subcategory select field.
  if (count($subcategory_options) > 1) {
    $form['field_subcategory']['widget']['#options'] = $subcategory_options;
    $form['field_subcategory']['widget']['#attributes']['disabled'] = NULL;
  }
  else {
    $form['field_subcategory']['widget']['#options'] = $subcategory_options;
    $form['field_subcategory']['widget']['#attributes']['disabled'] = NULL;
    $form['field_subcategory']['widget']['#default_value'] = NULL;
    // unset($form['field_subcategory']['widget']['#options']);
    // $form['field_subcategory']['widget'][0]['#value'] = NULL;
    // $form_state->setValue(['field_subcategory', 0, 'target_id'], NULL);.
  }
  // Return the updated subcategory field element.
  return $form['field_subcategory'];
}

/**
 * AJAX callback to filter Category options.
 *
 * Based on selected, Subject Area and Type of Article.
 */
function pb_custom_form_custom_article_filter_categories(array &$form, FormStateInterface $form_state) {
  // Get the selected subject area and type of article.
  $type_of_article = $form_state->getValue(['field_type_of_article', 0, 'target_id']);
  $options = pb_custom_form_get_content_category_option($type_of_article);
  if (count($options) > 1) {
    $form['field_content_category']['widget']['#options'] = $options;
    $form['field_content_category']['widget']['#attributes']['disabled'] = NULL;
  }
  else {
    // $form['field_content_category']['widget']['#options'] = $options;
    $form['field_content_category']['widget']['#default_value'] = NULL;
  }
  return $form['field_content_category'];
}

/**
 * Get content category options.
 */
function pb_custom_form_get_content_category_option($type_of_article) {
  if ($type_of_article) {
    // Load categories and filter them based on the selected subject area and
    // type of article.
    $categories = \Drupal::entityTypeManager()->getStorage('taxonomy_term')
      ->loadTree('category');
    $options = ['_none' => '- Select a value -'];
    foreach ($categories as $category) {
      $term = Term::load($category->tid);
      $category_type_of_article = $term->get('field_type_of_article')->target_id;
      // Only include categories that match  type of article.
      if ($category_type_of_article == $type_of_article) {
        $options[$category->tid] = $category->name;
      }
    }
    return $options;
  }
}

/**
 * Get subcategory options.
 */
function pb_custom_form_get_subcategory_options($category_id) {
  // This is a placeholder function; replace with actual logic.
  $options = ['_none' => '- Select a value -'];
  // Replace with your vocabulary machine name.
  $vid = 'subcategory';
  $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree($vid);
  $matched_terms = [];
  foreach ($terms as $term) {
    // Load the full term entity.
    $term_entity = Term::load($term->tid);
    // Check if the term has field_category with the specified ID.
    if ($term_entity->hasField('field_category') && !$term_entity->get('field_category')->isEmpty()) {
      $field_category = $term_entity->get('field_category')->getValue();
      foreach ($field_category as $value) {
        if ($value['target_id'] == $category_id) {
          $matched_terms[] = $term->tid;
          break;
        }
      }
    }
  }

  if ($matched_terms) {
    // Initialize an empty array to store term IDs and names.
    $terms = Term::loadMultiple($matched_terms);
    foreach ($terms as $term_id => $term) {
      // Check if the term is loaded successfully.
      if ($term) {
        // Get the name of the term.
        $options[$term_id] = $term->getName();
      }
    }
  }
  return $options;
}

/**
 * Implements hook_views_query_alter().
 */
function pb_custom_form_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  // Check if it's your specific view and display.
  if ($view->id() == 'articles' && $view->current_display == 'rest_export_2') {

    // Retrieve the contextual filter value.
    // Adjust index based on your view's configuration.
    // Retrieve all query parameters from the URL.
    $query_params = \Drupal::request()->query->all();

    // Check if the 'version' parameter is passed and is set to 2.
    // $query_params['version'] == '2'.
    if (isset($query_params['pregnancy']) && $query_params['pregnancy'] == 'true') {

      // Remove 'Child Age' filter (<> Pregnancy) condition dynamically.
      // Look for the condition related to 'Child Age' and remove it from the
      // query. Assuming 'field_child_age' is the machine name of the 'Child
      // Age' field.
      // @phpstan-ignore-next-line
      foreach ($query->where as &$where) {
        if (!empty($where['conditions'])) {
          foreach ($where['conditions'] as &$condition) {

            $field_condition = 'node__field_child_age.field_child_age_target_id IN(:node__field_child_age_field_child_age_target_id[])';
            if (isset($condition['field']) && $condition['field'] == $field_condition) {

              // Use cached pregnancy term ID to avoid repeated database lookups.
              $tid_pregnancy = _pb_custom_form_get_pregnancy_term_id();
              if ($tid_pregnancy) {
                $condition['value'][':node__field_child_age_field_child_age_target_id[]'][] = $tid_pregnancy;
              }
            }
          }
        }
      }
    }
  }
}

/**
 * Get the pregnancy term ID with caching.
 *
 * @return int|null
 *   The term ID or NULL if not found.
 */
function _pb_custom_form_get_pregnancy_term_id() {
  // Use static cache for within-request caching.
  $tid_pregnancy = &drupal_static(__FUNCTION__);

  if ($tid_pregnancy !== NULL) {
    return $tid_pregnancy;
  }

  // Check persistent cache.
  $cache = \Drupal::cache()->get('pb_custom_form:pregnancy_term_id');
  if ($cache && $cache->data) {
    $tid_pregnancy = $cache->data;
    return $tid_pregnancy;
  }

  // Load from database.
  $terms = \Drupal::entityTypeManager()
    ->getStorage('taxonomy_term')
    ->loadByProperties([
      'name' => 'Pregnancy',
      'vid' => 'child_age',
    ]);

  if ($terms) {
    $term = reset($terms);
    $tid_pregnancy = (int) $term->id();
    // Cache for 24 hours.
    \Drupal::cache()->set('pb_custom_form:pregnancy_term_id', $tid_pregnancy, \Drupal::time()->getRequestTime() + 86400);
    return $tid_pregnancy;
  }

  // Term not found, cache as 0 to avoid repeated lookups.
  $tid_pregnancy = 0;
  return NULL;
}

/**
 * Implements hook_theme().
 */
function pb_custom_form_theme($existing, $type, $theme, $path) {
  $config = \Drupal::config('pb_custom_form.mobile_app_share_link_form');

  return [
    'pb-mobile' => [
      'variables' => ['app_share_script' => $config->get('mobile_app_share_link')],
    ],
    'kosovo-mobile' => [
      'variables' => [
        'kosovo_app_share_script' => $config->get('kosovo_mobile_app_share_link'),
      ],
    ],
  ];
}

/**
 * Implements hook_query_TAG_alter() for tmgmt_entity_get_translatable_entities.
 */
function pb_custom_form_query_tmgmt_entity_get_translatable_entities_alter($query) {
  $request = \Drupal::request();
  $node_id_filter = $request->query->get('node_id');
  $order = $request->query->get('order');
  $sort = $request->query->get('sort', 'desc');

  // Add Node ID filtering.
  if (!empty($node_id_filter) && is_numeric($node_id_filter)) {
    $query->condition('e.nid', $node_id_filter, '=');
  }

  // Add Node ID sorting - override the default ordering.
  if ($order === 'node_id' || $order === 'nid') {
    // Clear existing order by clauses.
    $order_by = &$query->getOrderBy();
    $order_by = [];
    // Add our Node ID ordering.
    $query->orderBy('e.nid', strtoupper($sort));
  }
}

/**
 * Implements hook_form_alter().
 */
function pb_custom_form_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Add CSV Download button to Entity Share Pull form.
  if ($form_id == 'entity_share_client_pull_form') {
    pb_custom_form_add_csv_download_button($form, $form_state);

    // Add after_build callback to ensure button is added after AJAX rebuilds.
    $form['#after_build'][] = 'pb_custom_form_entity_share_after_build';
  }
  // Adding custom validation for the welcome page type field.
  if ($form_id == 'group_country_edit_form') {
    // Make readonly if offload country is enabled.
    $user = \Drupal::currentUser();
    $roles = $user->getRoles();
    $global_user = ['global_admin'];
    if (count(array_intersect($roles, $global_user)) != 0) {
      $mobile_default = $form['field_make_available_for_mobile']['widget']['value']['#default_value'];
      if ($mobile_default == 1) {
        $form['field_make_available_for_mobile']['widget']['value']['#disabled'] = 'true';
      }
      else {
        $form['field_make_available_for_mobile']['widget']['value']['#default_value'] = 'true';
      }
    }
    /* $form['#attached']['js'][] = drupal_get_path('module', 'pb_custom_field') . '/js/homepage.js'; */
    $form['#attached']['library'][] = 'pb_custom_field/mylib';
    $form['actions']['submit']['#submit'][] = 'pb_custom_form_group_country_save';
  }
  if (strpos($form_id, 'edit_form') !== FALSE && strpos($form_id, 'node') !== FALSE) {
    $form['#validate'][] = 'pb_custom_form_node_validate';
  }

  // node_article_edit_form //node_article_form.
  if ($form_id == 'node_article_edit_form' || $form_id == 'node_article_form') {
    // Attach the AJAX behavior to the 'field_subject_area'.
    if (isset($form['field_type_of_article'])) {
      $form['field_type_of_article']['widget']['#ajax'] = [
        'callback' => 'pb_custom_form_custom_article_filter_categories',
        'wrapper' => 'category-wrapper',
        'event' => 'change',
      ];
    }
    // Wrap the field_category field in a div so we can replace it via AJAX.
    $form['field_content_category']['#prefix'] = '<div id="category-wrapper">';
    $form['field_content_category']['#suffix'] = '</div>';
    if (isset($form['field_content_category'])) {
      $form['field_content_category']['widget']['#ajax'] = [
        'callback' => 'pb_custom_form_dynamic_category_ajax_callback',
        'wrapper' => 'subcategory-wrapper',
        'event' => 'change',
      ];
    }
    if (isset($form['field_subcategory'])) {
      $form['field_subcategory']['#prefix'] = '<div id="subcategory-wrapper">';
      $form['field_subcategory']['#suffix'] = '</div>';
    }
    $form['field_content_category']['widget']['#attributes']['disabled'] =
      'disabled';
    $form['field_subcategory']['widget']['#attributes']['disabled'] =
      'disabled';
    // $form['field_make_available_for_mobile']
    // ['widget']['value']['#disabled'] =
    // 'true';
    // Get the current value of the Category field.
    // $field_type_of_article = $form_state->getValue(['field_type_of_article',
    // 0, 'target_id']);
    // if (!$field_type_of_article &&
    // isset($form['field_type_of_article']['widget']['#default_value'][0])) {
    // $field_type_of_article =
    // $form['field_type_of_article']['widget']['#default_value'][0];
    // }
    // if ($field_type_of_article) {
    // $form['field_content_category']['widget']['#options'] =
    // get_content_category_option($field_type_of_article);
    // }
    // Subcategory.
    // $selected_category = $form_state->getValue(['field_content_category', 0,
    // 'target_id']);
    // if (!$selected_category &&
    // isset($form['field_content_category']['widget']['#default_value'][0])) {
    // $selected_category =
    // $form['field_content_category']['widget']['#default_value'][0];
    // }
    // if ($selected_category) {
    // $form['field_subcategory']['widget']['#options'] =
    // pb_custom_form_get_subcategory_options($selected_category);
    // }
    // // Add custom validation handler.
    // $form['#validate'][] = 'pb_custom_form_validate';.
  }

  if ($form_id == 'tmgmt_overview_form') {
    // Only modify if we're dealing with content entities (nodes).
    $plugin = $form_state->get('plugin');
    $item_type = $form_state->get('item_type');

    if ($plugin !== 'content' || $item_type !== 'node') {
      return;
    }

    // Add Node ID filter field to search form.
    if (isset($form['search_wrapper']['search'])) {
      $form['search_wrapper']['search']['node_id'] = [
        '#type' => 'textfield',
        '#title' => t('Node ID'),
        '#size' => 8,
        '#default_value' => \Drupal::request()->query->get('node_id', ''),
      ];
    }

    // Add process callback to handle sorting after form is built.
    $form['#process'][] = 'pb_custom_form_process_tmgmt_overview_form';

    // Modify the items table if it exists.
    if (isset($form['items']['#header'])) {
      // Get current sort parameters.
      $request = \Drupal::request();
      $current_order = $request->query->get('order');
      $current_sort = $request->query->get('sort', 'desc');
      $new_sort = ($current_order === 'node_id' && $current_sort === 'asc') ? 'desc' : 'asc';

      // Create sortable link for Node ID column.
      $sort_url = Url::fromRoute('<current>', [], [
        'query' => [
          'order' => 'node_id',
          'sort' => $new_sort,
        ] + $request->query->all(),
      ]);

      // Add Node ID as the first column.
      $header = $form['items']['#header'];
      $new_header = [
        'node_id' => [
          'data' => [
            '#type' => 'link',
            '#title' => t('Node ID'),
            '#url' => $sort_url,
            '#attributes' => [
              'title' => t('Sort by Node ID'),
              'style' => 'color: inherit; text-decoration: none;',
              'class' => ['node-id-header'],
            ],
          ],
        ],
      ];

      // Add the rest of the headers.
      foreach ($header as $key => $column) {
        $new_header[$key] = $column;
      }
      $form['items']['#header'] = $new_header;

      // Add Node ID data to each row.
      if (isset($form['items']['#options'])) {
        foreach ($form['items']['#options'] as $entity_id => &$row) {
          // Create new row with Node ID first.
          $new_row = [
            'node_id' => [
              'data' => [
                '#type' => 'link',
                '#title' => $entity_id,
                '#url' => Url::fromRoute('entity.node.edit_form', ['node' => $entity_id]),
                '#attributes' => ['target' => '_blank'],
              ],
            ],
          ];

          // Add the rest of the row data.
          foreach ($row as $key => $value) {
            $new_row[$key] = $value;
          }
          $row = $new_row;
        }
      }
    }
  }

  // Add Node ID column to TMGMT Cart form.
  if ($form_id == 'tmgmt_cart_form') {
    // Get current sort parameters for cart.
    $request = \Drupal::request();
    $current_order = $request->query->get('order');
    $current_sort = $request->query->get('sort', 'desc');
    $new_sort = ($current_order === 'node_id' && $current_sort === 'asc') ? 'desc' : 'asc';

    // Create sortable link for Node ID column in cart.
    $cart_sort_url = Url::fromRoute('<current>', [], [
      'query' => [
        'order' => 'node_id',
        'sort' => $new_sort,
      ] + $request->query->all(),
    ]);

    // Modify the items table if it exists.
    if (isset($form['items']['#header'])) {
      $header = $form['items']['#header'];
      $new_header = [
        'node_id' => [
          'data' => [
            '#type' => 'link',
            '#title' => t('Node ID'),
            '#url' => $cart_sort_url,
            '#attributes' => [
              'title' => t('Sort by Node ID'),
              'style' => 'color: inherit; text-decoration: none;',
              'class' => ['node-id-header'],
            ],
          ],
        ],
      ];

      // Add the rest of the headers.
      foreach ($header as $key => $column) {
        $new_header[$key] = $column;
      }
      $form['items']['#header'] = $new_header;

      // Add Node ID data to each row if items exist.
      if (isset($form['items']['#options']) && !empty($form['items']['#options'])) {
        $job_item_ids = array_map('intval', array_keys($form['items']['#options']));
        $node_map = [];
        if (!empty($job_item_ids)) {
          $connection = \Drupal::database();
          $results = $connection->select('tmgmt_job_item', 'ji')
            ->fields('ji', ['tjiid', 'item_id'])
            ->condition('ji.tjiid', $job_item_ids, 'IN')
            ->condition('ji.plugin', 'content')
            ->condition('ji.item_type', 'node')
            ->execute()
            ->fetchAllKeyed(0, 1);
          foreach ($results as $jid => $item_id) {
            $node_map[(int) $jid] = (int) $item_id;
          }
        }

        // Collect items for sorting.
        $items_data = [];
        foreach ($form['items']['#options'] as $job_item_id => $row) {
          $jid = (int) $job_item_id;
          $items_data[$job_item_id] = [
            'entity_id' => $node_map[$jid] ?? 0,
            'row' => $row,
          ];
        }

        // Sort items if Node ID sorting is requested.
        if ($current_order === 'node_id') {
          uasort($items_data, function ($a, $b) use ($current_sort) {
            $a_val = (int) $a['entity_id'];
            $b_val = (int) $b['entity_id'];
            return $current_sort === 'asc' ? $a_val <=> $b_val : $b_val <=> $a_val;
          });
        }

        // Rebuild options with Node ID data.
        $new_options = [];
        foreach ($items_data as $job_item_id => $data) {
          $entity_id = $data['entity_id'];
          $row = $data['row'];

          // Create new row with Node ID first.
          $new_row = [
            'node_id' => [
              'data' => [
                '#type' => 'link',
                '#title' => $entity_id ?: 'N/A',
                '#url' => $entity_id ? Url::fromRoute('entity.node.edit_form', ['node' => $entity_id]) : Url::fromRoute('<current>'),
                '#attributes' => $entity_id ? ['target' => '_blank'] : ['class' => ['disabled']],
              ],
            ],
          ];

          // Add the rest of the row data.
          foreach ($row as $key => $value) {
            $new_row[$key] = $value;
          }

          $new_options[$job_item_id] = $new_row;
        }
        $form['items']['#options'] = $new_options;
      }
    }
  }
}

/**
 * Implements validate function().
 */
function pb_custom_form_node_validate($form, FormStateInterface $form_state) {
  $user = \Drupal::currentUser();
  $roles = $user->getRoles();

  $roles_arr = [
    'administrator',
    'global_admin',
  ];

  if ($form_state->getValue('moderation_state')[0]['value'] == 'archive') {
    if (!array_intersect($roles_arr, $roles)) {
      if (empty($form_state->getValue('revision_log')[0]['value'])) {
        $form_state->setErrorByName('revision_log', t('Revision log message is required when archiving.'));
      }
      elseif (!empty($form_state->getValue('revision_log')[0]['value']) &&
              strlen(trim($form_state->getValue('revision_log')[0]['value'])) < 3) {
        $form_state->setErrorByName('revision_log',
          t('Revision log message is required when archiving.'));
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for tmgmt_overview_form.
 */
function pb_custom_form_form_tmgmt_overview_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Only modify if we're dealing with content entities (nodes).
  $plugin = $form_state->get('plugin');
  $item_type = $form_state->get('item_type');

  if ($plugin !== 'content' || $item_type !== 'node') {
    return;
  }

  // Handle manual sorting if the query alter didn't work.
  $request = \Drupal::request();
  $order = $request->query->get('order');
  $sort = $request->query->get('sort', 'desc');

  if (($order === 'node_id' || $order === 'nid') && isset($form['items']['#options'])) {
    // Sort the options array by entity ID.
    $options = $form['items']['#options'];
    if ($sort === 'asc') {
      ksort($options, SORT_NUMERIC);
    }
    else {
      krsort($options, SORT_NUMERIC);
    }
    $form['items']['#options'] = $options;
  }

  // Handle Node ID filtering.
  $node_id_filter = $request->query->get('node_id');
  if (!empty($node_id_filter) && is_numeric($node_id_filter) && isset($form['items']['#options'])) {
    $form['items']['#options'] = array_filter($form['items']['#options'], function ($key) use ($node_id_filter) {
      return $key == $node_id_filter;
    }, ARRAY_FILTER_USE_KEY);
  }

  // Force sorting to happen after form is built.
  if (($order === 'node_id' || $order === 'nid') && isset($form['items']['#options'])) {
    $form['#after_build'][] = 'pb_custom_form_after_build_tmgmt_overview_form';
  }
}

/**
 * After build callback for TMGMT overview form.
 */
function pb_custom_form_after_build_tmgmt_overview_form($form, FormStateInterface $form_state) {
  $request = \Drupal::request();
  $order = $request->query->get('order');
  $sort = $request->query->get('sort', 'desc');

  if (($order === 'node_id' || $order === 'nid') && isset($form['items']['#options'])) {
    $options = $form['items']['#options'];

    if ($sort === 'asc') {
      ksort($options, SORT_NUMERIC);
    }
    else {
      krsort($options, SORT_NUMERIC);
    }

    $form['items']['#options'] = $options;
  }

  return $form;
}

/**
 * Process callback for TMGMT overview form to handle Node ID sorting.
 */
function pb_custom_form_process_tmgmt_overview_form($element, FormStateInterface $form_state, $form) {
  $request = \Drupal::request();
  $order = $request->query->get('order');
  $sort = $request->query->get('sort', 'desc');

  // Apply sorting if Node ID column is selected.
  if (($order === 'node_id' || $order === 'nid') && isset($element['items']['#options'])) {
    $options = $element['items']['#options'];

    // Debug: Log the sorting parameters.
    \Drupal::logger('pb_custom_form')->info('Sorting by Node ID: order=@order, sort=@sort, count=@count', [
      '@order' => $order,
      '@sort' => $sort,
      '@count' => count($options),
    ]);

    if ($sort === 'asc') {
      ksort($options, SORT_NUMERIC);
    }
    else {
      krsort($options, SORT_NUMERIC);
    }
    $element['items']['#options'] = $options;
  }

  return $element;
}

/**
 * Custom submit handler for group country save.
 */
function pb_custom_form_group_country_save($form, FormStateInterface $form_state) {
  $field_make_available_for_mobiles = $form_state->getValue('field_make_available_for_mobile');
  $field_make_available_for_mobile = $field_make_available_for_mobiles['value'];
  if ($field_make_available_for_mobile == 1) {
    $country_language = $form_state->getValue('field_language');
    $country_languages_arry = [];
    if (!empty($country_language)) {
      foreach ($country_language as $value) {
        $country_languages_arry[] = $value['value'];
      }
    }
    $langcodess = [];
    $resultss = \Drupal::database()->select('node_field_data', 't')
      ->fields('t')
      ->condition('langcode', $country_languages_arry, 'IN')
      ->execute()
      ->fetchAll();
    if (!empty($resultss)) {
      foreach ($resultss as $val) {
        $langcode = $val->langcode;
        $nid = $val->nid;
        $nids[$langcode] = $val->nid;
        $langcodess[$nid][] = $val->langcode;
      }
    }
    $batch = [
      'title' => t('change status'),
      'operations' => [
      [
        '\Drupal\pb_custom_form\ChangeNodeStatus::offLoadCountryProcess',
        [$langcodess],
      ],
      ],
      'finished' => '\Drupal\pb_custom_form\ChangeNodeStatus::offLoadCountryProcessFinishedCallback',
    ];
    batch_set($batch);
  }

}

/**
 * Implements hook_preprocess_views_view_field().
 *
 * Optimized with batch loading and static caching.
 */
function pb_custom_form_pb_custom_field_preprocess_views_view_field(&$variables) {
  $view = $variables['view'];
  $field = $variables['field'];

  // Handle revision_uid field.
  if ($field->field == 'revision_uid') {
    $output = _pb_custom_form_get_revision_author($variables, $view);
    if ($output !== NULL) {
      $variables['output'] = $output;
    }
    return;
  }

  // Handle moderation_state field for country_content_listing view.
  if ($view->storage->id() == 'country_content_listing' &&
      $view->current_display == 'page_5' &&
      $field->field == 'moderation_state') {
    $output = _pb_custom_form_get_moderation_state_label($variables, $view);
    if ($output !== NULL) {
      $variables['output'] = $output;
    }
  }
}

/**
 * Get revision author with batch loading and caching.
 */
function _pb_custom_form_get_revision_author(&$variables, ViewExecutable $view) {
  // Use static cache for batch-loaded data.
  $cache = &drupal_static(__FUNCTION__, ['initialized' => FALSE, 'data' => []]);

  if (!$cache['initialized']) {
    $cache = _pb_custom_form_batch_load_revision_authors($view);
    $cache['initialized'] = TRUE;
  }

  if (!isset($variables['row']->_entity)) {
    return NULL;
  }

  $nid = $variables['row']->_entity->nid->value ?? $variables['row']->_entity->id();
  $langcode = $variables['row']->node_field_data_langcode ?? 'en';
  $cache_key = $nid . ':' . $langcode;

  return $cache['data'][$cache_key] ?? NULL;
}

/**
 * Get moderation state label with batch loading and caching.
 */
function _pb_custom_form_get_moderation_state_label(&$variables, ViewExecutable $view) {
  // Use static cache for batch-loaded data.
  $cache = &drupal_static(__FUNCTION__, ['initialized' => FALSE, 'data' => []]);

  if (!$cache['initialized']) {
    $cache = _pb_custom_form_batch_load_moderation_states($view);
    $cache['initialized'] = TRUE;
  }

  if (!isset($variables['row']->_entity) || !($variables['row']->_entity instanceof NodeInterface)) {
    return NULL;
  }

  $nid = $variables['row']->_entity->id();
  $langcode = $variables['row']->{'node_field_data_langcode'} ?? 'en';
  $cache_key = $nid . ':' . $langcode;

  return $cache['data'][$cache_key] ?? NULL;
}

/**
 * Batch load revision authors for all view results.
 */
function _pb_custom_form_batch_load_revision_authors(ViewExecutable $view) {
  $result = ['initialized' => TRUE, 'data' => []];

  if (empty($view->result)) {
    return $result;
  }

  $user_storage = \Drupal::entityTypeManager()->getStorage('user');
  $database = \Drupal::database();

  // Collect all node IDs from view results.
  $nid_langcode_map = [];
  foreach ($view->result as $row) {
    if (isset($row->_entity)) {
      $nid = $row->_entity->nid->value ?? $row->_entity->id();
      $langcode = $row->node_field_data_langcode ?? 'en';
      $nid_langcode_map[$nid . ':' . $langcode] = [
        'nid' => $nid,
        'langcode' => $langcode,
      ];
    }
  }

  if (empty($nid_langcode_map)) {
    return $result;
  }

  $nids = array_unique(array_column($nid_langcode_map, 'nid'));

  // Single query to get latest revision IDs and their revision UIDs.
  $query = $database->select('node_field_data', 'nfd');
  $query->fields('nfd', ['nid', 'langcode', 'vid']);
  $query->condition('nfd.nid', $nids, 'IN');
  $revision_data = $query->execute()->fetchAll();

  // Build revision map.
  $revision_map = [];
  $vids = [];
  foreach ($revision_data as $row) {
    $revision_map[$row->nid . ':' . $row->langcode] = $row->vid;
    $vids[$row->vid] = $row->vid;
  }

  // Batch load revision UIDs.
  if (!empty($vids)) {
    $uid_query = $database->select('node_revision', 'nr');
    $uid_query->fields('nr', ['vid', 'revision_uid']);
    $uid_query->condition('nr.vid', array_values($vids), 'IN');
    $uid_results = $uid_query->execute()->fetchAllKeyed();

    // Batch load users.
    $uids = array_unique(array_values($uid_results));
    $users = $user_storage->loadMultiple($uids);

    // Build the result cache.
    foreach ($nid_langcode_map as $cache_key => $info) {
      $vid = $revision_map[$cache_key] ?? NULL;
      if ($vid && isset($uid_results[$vid])) {
        $uid = $uid_results[$vid];
        if (isset($users[$uid])) {
          $result['data'][$cache_key] = $users[$uid]->name->value;
        }
      }
    }
  }

  return $result;
}

/**
 * Batch load moderation states for all view results.
 */
function _pb_custom_form_batch_load_moderation_states(ViewExecutable $view) {
  $result = ['initialized' => TRUE, 'data' => []];

  if (empty($view->result)) {
    return $result;
  }

  $moderation_information = \Drupal::service('content_moderation.moderation_information');
  $node_storage = \Drupal::entityTypeManager()->getStorage('node');
  $database = \Drupal::database();

  // Collect all node IDs from view results.
  $nid_langcode_map = [];
  foreach ($view->result as $row) {
    if (isset($row->_entity) && $row->_entity instanceof NodeInterface) {
      $nid = $row->_entity->id();
      $langcode = $row->{'node_field_data_langcode'} ?? 'en';
      $nid_langcode_map[$nid . ':' . $langcode] = [
        'nid' => $nid,
        'langcode' => $langcode,
      ];
    }
  }

  if (empty($nid_langcode_map)) {
    return $result;
  }

  $nids = array_unique(array_column($nid_langcode_map, 'nid'));

  // Single query to get content moderation states.
  $query = $database->select('content_moderation_state_field_data', 'cms');
  $query->fields('cms', ['content_entity_id', 'langcode', 'moderation_state']);
  $query->condition('cms.content_entity_type_id', 'node');
  $query->condition('cms.content_entity_id', $nids, 'IN');
  $moderation_data = $query->execute()->fetchAll();

  // Build moderation state map.
  $state_map = [];
  foreach ($moderation_data as $row) {
    $state_map[$row->content_entity_id . ':' . $row->langcode] = $row->moderation_state;
  }

  // Get workflow once (assuming same workflow for all nodes of same type).
  $workflow = NULL;
  $state_labels = [];

  // Load one sample node to get the workflow.
  $sample_nid = reset($nids);
  $sample_node = $node_storage->load($sample_nid);
  if ($sample_node && $moderation_information->isModeratedEntity($sample_node)) {
    $workflow = $moderation_information->getWorkflowForEntity($sample_node);
    if ($workflow) {
      // Pre-load all state labels.
      $type_plugin = $workflow->getTypePlugin();
      foreach ($type_plugin->getStates() as $state_id => $state) {
        $state_labels[$state_id] = $state->label();
      }
    }
  }

  // Build the result cache.
  foreach ($nid_langcode_map as $cache_key => $info) {
    $state_id = $state_map[$cache_key] ?? NULL;
    if ($state_id && isset($state_labels[$state_id])) {
      $result['data'][$cache_key] = $state_labels[$state_id];
    }
  }

  return $result;
}

/**
 * Implements hook_views_post_execute().
 *
 * This hook avoids duplicate entry of nodes in view to optimize API
 * performance.
 */
function pb_custom_form_views_post_execute(ViewExecutable $view) {
  // For child growth api - deduplicate results.
  if ($view->id() == 'articles') {
    $display = $view->getDisplay()->display['id'];

    // Map display to the field used for deduplication.
    $dedupe_field_map = [
      // Child Growth Pinned Content API & Milestone Related Content API.
      'rest_export_18' => 'node_field_data_node__field_related_articles_nid',
      'rest_export_20' => 'node_field_data_node__field_related_articles_nid',
      // Health Check-Ups, FAQ Pinned Content APIs.
      'rest_export_17' => 'node_field_data_node__field_pinned_article_nid',
      'rest_export_1' => 'node_field_data_node__field_pinned_article_nid',
      'rest_export_21' => 'node_field_data_node__field_pinned_article_nid',
      // Child Development Girl Pinned Content API.
      'rest_export_16' => 'node_field_data_node__field_pinned_article_for_girl_nid',
      // Child Development Boy Pinned Content API.
      'rest_export_19' => 'node_field_data_node__field_pinned_article_for_boy_nid',
    ];

    if (isset($dedupe_field_map[$display])) {
      $field_name = $dedupe_field_map[$display];
      // Optimized deduplication using associative array for O(1) lookups.
      $seen = [];
      $result = [];
      foreach ($view->result as $row) {
        $id = $row->{$field_name} ?? NULL;
        if ($id !== NULL && !isset($seen[$id])) {
          $seen[$id] = TRUE;
          $result[] = $row;
        }
      }
      $view->result = $result;
    }
  }
}

/**
 * Adds CSV Download button to Entity Share Pull form.
 */
function pb_custom_form_add_csv_download_button(&$form, FormStateInterface $form_state) {
  // Add CSV Download button to the actions section if it exists.
  if (isset($form['channel_wrapper']['entities_wrapper']['actions_bottom'])) {
    $form['channel_wrapper']['entities_wrapper']['actions_bottom']['csv_download'] = [
      '#type' => 'submit',
      '#value' => t('CSV Download'),
      '#submit' => ['pb_custom_form_csv_download_redirect'],
      '#button_type' => 'primary',
      '#limit_validation_errors' => [],
      '#validate' => [],
    ];
  }

  // Also add to top actions if they exist.
  if (isset($form['channel_wrapper']['entities_wrapper']['actions_top'])) {
    $form['channel_wrapper']['entities_wrapper']['actions_top']['csv_download'] = [
      '#type' => 'submit',
      '#value' => t('CSV Download'),
      '#submit' => ['pb_custom_form_csv_download_redirect'],
      '#button_type' => 'primary',
      '#limit_validation_errors' => [],
      '#validate' => [],
    ];
  }
}

/**
 * After build callback for Entity Share Pull form.
 */
function pb_custom_form_entity_share_after_build($form, FormStateInterface $form_state) {
  // Ensure CSV download button is added after AJAX rebuilds.
  pb_custom_form_add_csv_download_button($form, $form_state);
  return $form;
}

/**
 * Submit handler for CSV download redirect.
 */
function pb_custom_form_csv_download_redirect($form, FormStateInterface $form_state) {
  $route_name = 'pb_custom_form.csv_export';

  // Get current form values to pass as query parameters
  // The entity_share client form may nest elements in wrappers or use
  // different keys. Try multiple strategies to retrieve values.
  $remote_id = NULL;
  $channel_id = NULL;
  $import_config_id = NULL;

  // Preferred direct keys.
  if ($val = $form_state->getValue('remote')) {
    $remote_id = $val;
  }
  if ($val = $form_state->getValue('channel')) {
    $channel_id = $val;
  }
  if ($val = $form_state->getValue('import_config')) {
    $import_config_id = $val;
  }

  // Sometimes the form nests values under wrappers, try common nested keys.
  if (empty($remote_id) && $form_state->hasValue(['channel_wrapper', 'remote'])) {
    $remote_id = $form_state->getValue(['channel_wrapper', 'remote']);
  }
  if (empty($channel_id) && $form_state->hasValue(['channel_wrapper', 'channel'])) {
    $channel_id = $form_state->getValue(['channel_wrapper', 'channel']);
  }

  // Another nesting pattern: entities_wrapper -> remote/channel.
  if (empty($remote_id) && $form_state->hasValue(['channel_wrapper', 'entities_wrapper', 'remote'])) {
    $remote_id = $form_state->getValue(['channel_wrapper', 'entities_wrapper', 'remote']);
  }
  if (empty($channel_id) && $form_state->hasValue(['channel_wrapper', 'entities_wrapper', 'channel'])) {
    $channel_id = $form_state->getValue(['channel_wrapper', 'entities_wrapper', 'channel']);
  }

  // Fallback to user input (for AJAX forms that don't store in getValues()).
  if (empty($remote_id) || empty($channel_id)) {
    $user_input = $form_state->getUserInput();
    if (empty($remote_id) && !empty($user_input['remote'])) {
      $remote_id = $user_input['remote'];
    }
    if (empty($channel_id) && !empty($user_input['channel'])) {
      $channel_id = $user_input['channel'];
    }
    if (empty($import_config_id) && !empty($user_input['import_config'])) {
      $import_config_id = $user_input['import_config'];
    }
  }

  // Fallback to request query parameters (used when AJAX put values in URL).
  if (empty($remote_id) || empty($channel_id)) {
    $request = \Drupal::request();
    if (empty($remote_id)) {
      $remote_id = $request->query->get('remote');
    }
    if (empty($channel_id)) {
      $channel_id = $request->query->get('channel');
    }
    if (empty($import_config_id)) {
      $import_config_id = $request->query->get('import_config');
    }
  }

  // If remote_id is empty but there's only one remote configured.
  if (empty($remote_id)) {
    try {
      $remote_storage = \Drupal::entityTypeManager()->getStorage('remote');
      $remotes = $remote_storage->loadMultiple();
      if (count($remotes) === 1) {
        $remote_id = array_keys($remotes)[0];
        \Drupal::logger('pb_custom_form')->info('Auto-selected single remote @remote for CSV export', [
          '@remote' => $remote_id,
        ]);
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('pb_custom_form')->error('Failed to auto-select remote: @error', [
        '@error' => $e->getMessage(),
      ]);
    }
  }

  // Validate required parameters.
  if (empty($channel_id) || empty($remote_id)) {
    \Drupal::logger('pb_custom_form')->warning('CSV export requested but channel or remote not set. remote=@remote channel=@channel form_values=@values user_input=@input', [
      '@remote' => $remote_id,
      '@channel' => $channel_id,
      '@values' => json_encode($form_state->getValues()),
      '@input' => json_encode($form_state->getUserInput()),
    ]);
    \Drupal::messenger()->addError(t('Channel and Remote website are required for CSV export. Remote: @remote, Channel: @channel', [
      '@remote' => $remote_id ?: 'empty',
      '@channel' => $channel_id ?: 'empty',
    ]));
    return;
  }

  try {
    // Ensure the route exists before attempting to build a URL for it.
    \Drupal::service('router.route_provider')->getRouteByName($route_name);

    $query_params = [
      'remote' => $remote_id,
      'channel' => $channel_id,
    ];

    if (!empty($import_config_id)) {
      $query_params['import_config'] = $import_config_id;
    }

    $url = Url::fromRoute($route_name, [], [
      'query' => $query_params,
    ]);
    $form_state->setRedirectUrl($url);
  }
  catch (RouteNotFoundException $e) {
    // Log the problem and show a friendly message instead of throwing an
    // exception which would break the page.
    \Drupal::logger('pb_custom_form')->error('CSV export route not found: @msg', ['@msg' => $e->getMessage()]);
    \Drupal::messenger()->addError(t('CSV export is currently unavailable. Please contact an administrator.'));
    // Redirect back to the current page to avoid the exception interrupting the
    // user's workflow.
    $form_state->setRedirect('<current>');
  }
}

/**
 * Implements hook_page_attachments_alter().
 *
 * Allows alteration of page attachments before rendering.
 */
function pb_custom_form_page_attachments_alter(&$page) {
  $page['#attached']['library'][] = 'pb_custom_form/bootstrap';
}

/**
 * Implements hook_preprocess_page().
 */
function pb_custom_form_preprocess_page(&$variables) {
  // Ensure TMGMT local tasks are always visible on TMGMT pages.
  $route_name = \Drupal::routeMatch()->getRouteName();

  if (strpos($route_name, 'tmgmt.') === 0) {
    $variables['#cache']['contexts'][] = 'route';
  }
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function pb_custom_form_menu_local_tasks_alter(&$data, $route_name) {
  // Add TMGMT local tasks to source overview pages.
  if (in_array($route_name, ['tmgmt.source_overview', 'tmgmt.source_overview_default'])) {
    // Manually build the local tasks for TMGMT pages.
    $data['tabs'][0]['tmgmt.job_items'] = [
      '#theme' => 'menu_local_task',
      '#link' => [
        'title' => t('Job Items'),
        'url' => Url::fromRoute('view.tmgmt_translation_all_job_items.page_1'),
      ],
      '#active' => FALSE,
      '#weight' => 5,
    ];

    $data['tabs'][0]['tmgmt.jobs'] = [
      '#theme' => 'menu_local_task',
      '#link' => [
        'title' => t('Jobs'),
        'url' => Url::fromRoute('view.tmgmt_job_overview.page_1'),
      ],
      '#active' => FALSE,
      '#weight' => 10,
    ];

    $data['tabs'][0]['tmgmt.sources'] = [
      '#theme' => 'menu_local_task',
      '#link' => [
        'title' => t('Sources'),
        'url' => Url::fromRoute('tmgmt.source_overview_default'),
      ],
      '#active' => TRUE,
      '#weight' => 15,
    ];

    $data['tabs'][0]['tmgmt.cart'] = [
      '#theme' => 'menu_local_task',
      '#link' => [
        'title' => t('Cart'),
        'url' => Url::fromRoute('tmgmt.cart'),
      ],
      '#active' => FALSE,
      '#weight' => 20,
    ];

    $data['tabs'][0]['tmgmt.translators'] = [
      '#theme' => 'menu_local_task',
      '#link' => [
        'title' => t('Providers'),
        'url' => Url::fromRoute('entity.tmgmt_translator.collection'),
      ],
      '#active' => FALSE,
      '#weight' => 90,
    ];

    $data['tabs'][0]['tmgmt.settings'] = [
      '#theme' => 'menu_local_task',
      '#link' => [
        'title' => t('Settings'),
        'url' => Url::fromRoute('tmgmt.settings'),
      ],
      '#active' => FALSE,
      '#weight' => 100,
    ];
  }
}

/**
 * For redirect page.
 */
function pb_custom_form_my_goto($path) {
  $response = new RedirectResponse($path);
  $response->send();
  return $response;
}
