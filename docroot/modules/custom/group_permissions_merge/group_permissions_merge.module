<?php

/**
 * @file
 * Group Permissions Merge module.
 */

use Drupal\node\NodeInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\group\Entity\GroupInterface;
use Drupal\Core\Access\AccessResult;

/**
 * Implements hook_group_permission_alter().
 */
function group_permissions_merge_group_permission_alter(array &$permissions, GroupInterface $group, AccountInterface $account) {
  // Only process for users with editor, senior editor, or SME roles.
  $user_roles = $account->getRoles();
  $target_roles = ['editor', 'se', 'sme'];

  if (!array_intersect($user_roles, $target_roles)) {
    return;
  }

  // Get all groups the user belongs to.
  $group_membership_loader = \Drupal::service('group.membership_loader');
  $memberships = $group_membership_loader->loadByUser($account);

  $merged_permissions = [];

  foreach ($memberships as $membership) {
    $group_roles = $membership->getRoles();

    foreach ($group_roles as $group_role) {
      $role_permissions = $group_role->getPermissions();
      $merged_permissions = array_merge($merged_permissions, $role_permissions);
    }
  }

  // Merge with existing permissions and remove duplicates.
  $permissions = array_unique(array_merge($permissions, $merged_permissions));
}

/**
 * Implements hook_entity_access().
 */
function group_permissions_merge_entity_access(EntityInterface $entity, $operation, AccountInterface $account) {
  // Only handle node entities for multi-country access.
  if ($entity->getEntityTypeId() !== 'node') {
    return AccessResult::neutral();
  }

  $service = \Drupal::service('group_permissions_merge.service');

  if ($service->hasNodeAccess($account, $entity, $operation)) {
    return AccessResult::allowed()->addCacheContexts(['user.group_permissions']);
  }

  return AccessResult::neutral();
}

/**
 * Implements hook_node_access().
 */
function group_permissions_merge_node_access(NodeInterface $node, $op, AccountInterface $account) {
  $allowed_operations = ['view', 'update', 'delete'];
  if (!in_array($op, $allowed_operations)) {
    return AccessResult::neutral();
  }

  $service = \Drupal::service('group_permissions_merge.service');

  if ($service->hasNodeAccess($account, $node, $op)) {
    return AccessResult::allowed()->addCacheContexts(['user.group_permissions']);
  }

  return AccessResult::neutral();
}
