<?php

/**
 * @file
 * Group Permissions Merge module.
 *
 * Provides multi-country access functionality for users.
 */

use Drupal\Core\Entity\FieldableEntityInterface;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityFormInterface;
use Drupal\user\Entity\Role;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\group\Entity\GroupInterface;
use Drupal\group\Entity\GroupContentInterface;
use Drupal\group_permissions_merge\GroupPermissionsMergeService;
use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\views\Plugin\views\query\Sql;

/**
 * Implements hook_group_permission_alter().
 */
function group_permissions_merge_group_permission_alter(array &$permissions, GroupInterface $group, AccountInterface $account) {
  $user_roles = $account->getRoles();

  if (array_intersect($user_roles, GroupPermissionsMergeService::getTrustedRoles())) {
    return;
  }

  $target_roles = GroupPermissionsMergeService::getTargetRoles();
  if (!array_intersect($user_roles, $target_roles)) {
    return;
  }

  // Get all groups the user belongs to.
  $group_membership_loader = \Drupal::service('group.membership_loader');
  $memberships = $group_membership_loader->loadByUser($account);

  $merged_permissions = [];

  foreach ($memberships as $membership) {
    $group_roles = $membership->getRoles();

    // Flatten permissions from all roles.
    $role_permissions = array_reduce($group_roles, function ($carry, $role) {
      return array_merge($carry, $role->getPermissions());
    }, []);

    $merged_permissions = array_merge($merged_permissions, $role_permissions);
  }

  // Merge with existing permissions and remove duplicates.
  $permissions = array_unique(array_merge($permissions, $merged_permissions));
}

/**
 * Implements hook_group_content_update().
 */
function group_permissions_merge_group_content_update(GroupContentInterface $group_content) {
  // Sync user allowed_languages when group membership changes.
  if ($group_content->getContentPlugin()->getPluginId() === 'group_membership') {
    _group_permissions_merge_sync_user_languages($group_content->getEntity());
  }
}

/**
 * Implements hook_group_content_delete().
 */
function group_permissions_merge_group_content_delete(GroupContentInterface $group_content) {
  // Sync user allowed_languages when group membership is removed.
  if ($group_content->getContentPlugin()->getPluginId() === 'group_membership') {
    _group_permissions_merge_sync_user_languages($group_content->getEntity());
  }
}

/**
 * Helper function to get all languages from user's groups.
 *
 * @param \Drupal\Core\Session\AccountInterface $user
 *   The user account.
 *
 * @return array
 *   Array of language codes from all user's groups.
 */
function _group_permissions_merge_get_user_group_languages(AccountInterface $user) {
  $group_languages = [];

  try {
    $membership_loader = \Drupal::service('group.membership_loader');
    $memberships = $membership_loader->loadByUser($user);

    foreach ($memberships as $membership) {
      $group = $membership->getGroup();
      if ($group && $group->hasField('field_language') && !$group->get('field_language')->isEmpty()) {
        $languages = $group->get('field_language')->getValue();
        $lang_values = array_filter(array_column($languages, 'value'));
        $group_languages = array_merge($group_languages, $lang_values);
      }
    }

    return array_unique($group_languages);
  }
  catch (\Exception $e) {
    return [];
  }
}

/**
 * Helper function to sync user's allowed_languages field with group.
 */
function _group_permissions_merge_sync_user_languages(AccountInterface $user) {
  try {
    // Only sync for users with editor, senior editor, or SME roles.
    $user_roles = $user->getRoles();
    $target_roles = GroupPermissionsMergeService::getTargetRoles();

    if (!array_intersect($user_roles, $target_roles)) {
      return;
    }
    /** @var \Drupal\user\UserInterface $user */
    if (!$user->hasField('allowed_languages')) {
      return;
    }

    $membership_loader = \Drupal::service('group.membership_loader');
    $memberships = $membership_loader->loadByUser($user);

    if (empty($memberships)) {
      return;
    }

    $group_languages = [];
    foreach ($memberships as $membership) {
      $group = $membership->getGroup();
      if ($group && $group->hasField('field_language') && !$group->get('field_language')->isEmpty()) {
        $languages = $group->get('field_language')->getValue();
        // Extract language values and filter.
        $lang_values = array_filter(array_column($languages, 'value'));
        $group_languages = array_unique(array_merge($group_languages, $lang_values));
      }
    }

    // For multi-country users.
    if (count($memberships) > 1) {
      $unique_languages = array_map(function ($langcode) {
        return ['target_id' => $langcode];
      }, $group_languages);

      $user->set('allowed_languages', $unique_languages);
      $user->save();

      // Clear any cached allowed languages for this user.
      if (\Drupal::hasService('allowed_languages.allowed_languages_manager')) {
        \Drupal::service('cache.default')->delete('allowed_languages:' . $user->id());
      }
      return;
    }

    // Single country user - only add missing languages.
    $current_langs = $user->get('allowed_languages')->getValue();
    $current_langcodes = array_column($current_langs, 'target_id');

    // Check if sync is needed.
    $missing_languages = array_diff($group_languages, $current_langcodes);

    if (!empty($missing_languages)) {
      // Combine existing and missing languages.
      $all_langcodes = array_unique(array_filter(array_merge($current_langcodes, $missing_languages)));

      $unique_languages = array_map(function ($langcode) {
        return ['target_id' => $langcode];
      }, $all_langcodes);

      $user->set('allowed_languages', $unique_languages);
      $user->save();

      // Clear any cached allowed languages for this user.
      if (\Drupal::hasService('allowed_languages.allowed_languages_manager')) {
        \Drupal::service('cache.default')->delete('allowed_languages:' . $user->id());
      }
    }
  }
  catch (\Exception $e) {
  }
}

/**
 * Implements hook_views_query_alter().
 */
function group_permissions_merge_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  $account = \Drupal::currentUser();
  $user_roles = $account->getRoles();

  if (array_intersect($user_roles, GroupPermissionsMergeService::getTrustedRoles())) {
    return;
  }

  // Only process for users with target roles.
  if (!array_intersect($user_roles, GroupPermissionsMergeService::getTargetRoles())) {
    return;
  }

  // Specifically target the country_content_listing view.
  if ($view->id() !== 'country_content_listing') {
    return;
  }

  // Get user's group memberships.
  $membership_loader = \Drupal::service('group.membership_loader');
  $memberships = $membership_loader->loadByUser($account);

  if (empty($memberships)) {
    return;
  }

  // Remove or modify the allowed_languages filter for multi-country users.
  $filters = &$query->where;
  foreach ($filters as &$filter_group) {
    if (isset($filter_group['conditions'])) {
      foreach ($filter_group['conditions'] as $condition_key => $condition) {
        // Remove allowed_languages restrictions for multi-country users.
        if (isset($condition['field']) && strpos($condition['field'], 'allowed_languages') !== FALSE) {
          unset($filter_group['conditions'][$condition_key]);
        }
      }
    }
  }

  // Get all group IDs the user belongs to.
  $user_group_ids = [];
  foreach ($memberships as $membership) {
    $user_group_ids[] = $membership->getGroup()->id();
  }
  if ($user_group_ids) {
    // Ensure the group_content relationship exists.
    if ($query instanceof Sql) {
      if (!isset($query->relationships['group_content'])) {
        $configuration = [
          'type' => 'LEFT',
          'table' => 'group_content_field_data',
          'field' => 'entity_id',
          'left_table' => 'node_field_data',
          'left_field' => 'nid',
          'operator' => '=',
        ];

        $join = \Drupal::service('plugin.manager.views.join')->createInstance('standard', $configuration);
        $query->addRelationship('group_content_multi_country', $join, 'node_field_data');

        // Add condition to include nodes from user's groups.
        $query->addWhere(0, 'group_content_multi_country.gid', $user_group_ids, 'IN');
      }
    }
  }
}

/**
 * Implements hook_views_pre_execute().
 */
function group_permissions_merge_views_pre_execute(ViewExecutable $view) {
  $account = \Drupal::currentUser();
  $user_roles = $account->getRoles();

  if (array_intersect($user_roles, GroupPermissionsMergeService::getTrustedRoles())) {
    return;
  }

  // Only process for users with target roles and specific views.
  if (!array_intersect($user_roles, GroupPermissionsMergeService::getTargetRoles()) ||
      $view->id() !== 'country_content_listing') {
    return;
  }

  // Ensure user's allowed_languages are synced before the view executes.
  $user_entity = \Drupal::entityTypeManager()->getStorage('user')->load($account->id());
  if ($user_entity) {
    // Check if user's allowed_languages are empty or need updating.
    $current_langs = $user_entity->get('allowed_languages')->getValue();
    if (empty($current_langs)) {
      _group_permissions_merge_sync_user_languages($user_entity);
      // Reload user after sync.
      $user_entity = \Drupal::entityTypeManager()->getStorage('user')->load($account->id());
    }
  }

  // Get user's group memberships.
  $membership_loader = \Drupal::service('group.membership_loader');
  $memberships = $membership_loader->loadByUser($account);

  if (count($memberships) <= 1) {
    // Single country user, no need to modify.
    return;
  }

  $filters = &$view->filter;
  if (isset($filters['allowed_languages'])) {
    // Get all languages from user's groups.
    $user_languages = [];
    foreach ($memberships as $membership) {
      $group = $membership->getGroup();
      if ($group && $group->hasField('field_language') && !$group->get('field_language')->isEmpty()) {
        $languages = $group->get('field_language')->getValue();
        $lang_values = array_filter(array_column($languages, 'value'));
        $user_languages = array_merge($user_languages, $lang_values);
      }
    }

    // Also include user's current allowed_languages.
    if ($user_entity && $user_entity->hasField('allowed_languages')) {
      $current_langs = $user_entity->get('allowed_languages')->getValue();
      $current_langcodes = array_column($current_langs, 'target_id');
      $user_languages = array_merge($user_languages, $current_langcodes);
    }

    $user_languages = array_unique(array_filter($user_languages));

    if (!empty($user_languages)) {
      $filters['allowed_languages']->value = $user_languages;
      $filters['allowed_languages']->operator = 'in';
    }
  }
}

/**
 * Implements hook_user_login().
 */
function group_permissions_merge_user_login($account) {
  // Check if user has target roles and empty allowed_languages.
  if (array_intersect($account->getRoles(), GroupPermissionsMergeService::getTargetRoles())) {
    if ($account->hasField('allowed_languages')) {
      $current_langs = $account->get('allowed_languages')->getValue();
      if (empty($current_langs)) {
        // Sync languages on login if they're empty.
        _group_permissions_merge_sync_user_languages($account);
      }
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function group_permissions_merge_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  try {
    $user = \Drupal::currentUser();
    $user_roles = $user->getRoles();

    // Only process for group-controlled target roles.
    if (!array_intersect($user_roles, GroupPermissionsMergeService::getTargetRoles())) {
      return;
    }

    // Check if user has multiple group memberships.
    $membership_loader = \Drupal::service('group.membership_loader');
    $memberships = $membership_loader->loadByUser($user);

    if (count($memberships) <= 1) {
      // Single country user, no need to override.
      return;
    }

    // For node forms, we need to intercept the validation.
    $route_match = \Drupal::routeMatch();
    if ($route_match->getRouteName() == "node.add" ||
        $route_match->getRouteName() == "entity.node.edit_form" ||
        $form_id == "content-moderation-entity-moderation-form") {

      // Store multi-country user info in form state for later use.
      $form_state->set('group_permissions_merge_multi_country_user', $user->id());

      // Collect all languages from all groups for this user.
      $all_group_languages = [];
      foreach ($memberships as $membership) {
        $group = $membership->getGroup();
        if ($group && $group->hasField('field_language') && !$group->get('field_language')->isEmpty()) {
          $country_languages = $group->get('field_language')->getValue();
          foreach ($country_languages as $mlangval) {
            if (!empty($mlangval['value'])) {
              $all_group_languages[] = $mlangval['value'];
            }
          }
        }
      }
      $all_group_languages = array_unique(array_filter($all_group_languages));
      $form_state->set('group_permissions_merge_allowed_languages', $all_group_languages);

      // Add our pre-validation that runs before pb_custom_field validation.
      if (!empty($all_group_languages)) {
        array_unshift($form['#validate'], 'group_permissions_merge_pre_validation');
      }
    }
  }
  catch (\Exception $e) {
    return;
  }
}

/**
 * Custom validation that runs before pb_custom_field validation.
 */
function group_permissions_merge_pre_validation(&$form, FormStateInterface $form_state) {
  try {
    // Check if this is a multi-country user.
    $multi_country_user_id = $form_state->get('group_permissions_merge_multi_country_user');
    $allowed_languages = $form_state->get('group_permissions_merge_allowed_languages');

    if (!$multi_country_user_id || !is_array($allowed_languages) || empty($allowed_languages)) {
      // Not a multi-country user, let original validation handle it.
      return;
    }

    $user = \Drupal::currentUser();
    $roles = $user->getRoles();
    $bypass_access = FALSE;

    // Check for bypass node access permission.
    foreach ($roles as $rval) {
      if ($rval != "authenticated") {
        $role = Role::load($rval);
        if ($role && in_array('bypass node access', $role->getPermissions())) {
          $bypass_access = TRUE;
          break;
        }
      }
    }

    // If user has bypass access, allow everything.
    if ($bypass_access) {
      $form_state->set('group_permissions_merge_bypass_original', TRUE);
      return;
    }

    // Get the form language.
    $form_language = $form_state->get('langcode');

    // If no form language is set, try to get it from the node.
    if (empty($form_language)) {
      $form_object = $form_state->getFormObject();
      if ($form_object instanceof EntityFormInterface) {
        $entity = $form_object->getEntity();
        if ($entity && method_exists($entity, 'language')) {
          $form_language = $entity->language()->getId();
        }
      }
    }

    // Check if form language is allowed for multi-country user.
    if (!empty($form_language) && is_array($allowed_languages)) {
      if (in_array($form_language, $allowed_languages)) {
        // User has access to this language, bypass original validation.
        $form_state->set('group_permissions_merge_bypass_original', TRUE);
      }
      else {
        // User doesn't have access, show error and bypass original validation.
        $form_state->setErrorByName('', 'This content belongs to Master content and cannot be edited. It has to be assigned to your country to allow for further editing and contextualization.');
        $form_state->set('group_permissions_merge_bypass_original', TRUE);
      }
    }
  }
  catch (\Exception $e) {
    // If anything goes wrong, let the original validation handle it.
    return;
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function group_permissions_merge_module_implements_alter(&$implementations, $hook) {
  // Ensure our hooks run after pb_custom_field and Group module's hooks.
  if (in_array($hook, [
    'form_alter', 'views_query_alter', 'views_pre_execute', 'user_login', 'node_access', 'entity_access',
  ])) {
    if (isset($implementations['group_permissions_merge'])) {
      $group = $implementations['group_permissions_merge'];
      unset($implementations['group_permissions_merge']);
      $implementations['group_permissions_merge'] = $group;
    }
  }

  // Specifically for form_alter, ensure we run after pb_custom_field.
  if ($hook === 'form_alter' && isset($implementations['pb_custom_field']) && isset($implementations['group_permissions_merge'])) {
    $group_permissions_merge = $implementations['group_permissions_merge'];
    unset($implementations['group_permissions_merge']);
    $implementations['group_permissions_merge'] = $group_permissions_merge;
  }
}

/**
 * Helper function to check if trusted user can access content.
 */
function _group_permissions_merge_check_country_access(EntityInterface $entity, AccountInterface $account) {
  try {
    // Get user's group memberships.
    $membership_loader = \Drupal::service('group.membership_loader');
    $user_memberships = $membership_loader->loadByUser($account);

    if (empty($user_memberships)) {
      return AccessResult::forbidden()->cachePerUser();
    }

    $user_group_ids = [];
    foreach ($user_memberships as $membership) {
      $group = $membership->getGroup();
      if ($group) {
        $user_group_ids[] = $group->id();
      }
    }

    // Check if node belongs to any of user's groups.
    $group_contents = \Drupal::entityTypeManager()
      ->getStorage('group_content')
      ->loadByProperties([
        'entity_id' => $entity->id(),
      ]);

    if (empty($group_contents)) {
      return AccessResult::forbidden()->cachePerUser();
    }

    foreach ($group_contents as $group_content) {
      // Try different ways to get the group ID.
      $node_group_id = NULL;
      if (method_exists($group_content, 'getGroup')) {
        $group = $group_content->getGroup();
        if ($group) {
          $node_group_id = $group->id();
        }
      }

      // Fallback to direct field access.
      if (!$node_group_id && $group_content instanceof FieldableEntityInterface) {
        if ($group_content->hasField('gid')) {
          $node_group_id = $group_content->get('gid')->value;
        }
      }

      if ($node_group_id && in_array($node_group_id, $user_group_ids)) {
        // User is assigned to the node's country - allow access.
        return AccessResult::allowed()->cachePerUser()->addCacheTags(['group_list', 'group_content_list']);
      }
    }

    // Node belongs to groups but user is not assigned to any of them - deny.
    return AccessResult::forbidden()->cachePerUser();

  }
  catch (\Exception $e) {
    \Drupal::logger('group_permissions_merge')->error('Error in country access check: @message', ['@message' => $e->getMessage()]);
    return AccessResult::neutral();
  }
}
