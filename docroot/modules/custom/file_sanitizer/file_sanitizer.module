<?php

/**
 * @file
 * Provides filename sanitization for file uploads and existing files.
 */

use Drupal\Core\File\FileExists;
use Drupal\Core\StreamWrapper\StreamWrapperManager;
use Drupal\file\FileInterface;

/**
 * Implements hook_file_presave().
 */
function file_sanitizer_file_presave(FileInterface $file) {

  $initial_uri = $file->getFileUri();
  $initial_filename = $file->getFilename();

  \Drupal::logger('file_sanitizer')->notice(
    '=== FILE_PRESAVE START === fid=@fid isNew=@new',
    [
      '@fid' => $file->id() ?? 'NEW',
      '@new' => $file->isNew() ? 'YES' : 'NO',
    ]
  );

  \Drupal::logger('file_sanitizer')->notice(
    'INITIAL STATE: filename="@filename" | uri="@uri" | scheme=@scheme | target=@target',
    [
      '@filename' => $initial_filename,
      '@uri' => $initial_uri,
      '@scheme' => StreamWrapperManager::getScheme($initial_uri),
      '@target' => StreamWrapperManager::getTarget($initial_uri),
    ]
  );

  // Only NEW uploads.
  if (!$file->isNew()) {
    return;
  }

  $filename = $file->getFilename();

  /** @var \Drupal\file_sanitizer\Service\FilenameSanitizer $sanitizer */
  $sanitizer = \Drupal::service('file_sanitizer.filename_sanitizer');

  if (!$sanitizer->needsSanitization($filename)) {
    return;
  }

  $sanitized_filename = $sanitizer->sanitize($filename);

  \Drupal::logger('file_sanitizer')->notice(
    'SANITIZATION: "@old" â†’ "@new"',
    [
      '@old' => $filename,
      '@new' => $sanitized_filename,
    ]
  );

  // For files in temporary storage, we must physically rename the file
  // AND update the URI. Drupal's copy operation uses basename($uri),
  // so just updating the filename field is not enough.
  if (str_starts_with($file->getFileUri(), 'temporary://')) {

    $old_uri = $file->getFileUri();
    $new_uri = 'temporary://' . $sanitized_filename;

    \Drupal::logger('file_sanitizer')->notice(
      'TEMPORARY FILE DETECTED: old_uri="@old" | new_uri="@new"',
      [
        '@old' => $old_uri,
        '@new' => $new_uri,
      ]
    );

    try {
      // Physically rename/move the file in temporary storage.
      $file_system = \Drupal::service('file_system');

      \Drupal::logger('file_sanitizer')->notice(
        'BEFORE MOVE: Calling file_system->move(source="@src", dest="@dest")',
        [
          '@src' => $old_uri,
          '@dest' => $new_uri,
        ]
      );

      $final_uri = $file_system->move(
        $old_uri,
        $new_uri,
        FileExists::Replace
      );

      \Drupal::logger('file_sanitizer')->notice(
        'AFTER MOVE: final_uri="@uri" | scheme=@scheme | target=@target',
        [
          '@uri' => $final_uri,
          '@scheme' => StreamWrapperManager::getScheme($final_uri),
          '@target' => StreamWrapperManager::getTarget($final_uri),
        ]
      );

      // Update both filename and URI to match the sanitized name.
      $file->setFilename($sanitized_filename);
      $file->setFileUri($final_uri);

      \Drupal::logger('file_sanitizer')->notice(
        'FILE ENTITY UPDATED: filename="@filename" | uri="@uri"',
        [
          '@filename' => $file->getFilename(),
          '@uri' => $file->getFileUri(),
        ]
      );
    }
    catch (\Exception $e) {
      \Drupal::logger('file_sanitizer')->error(
        'MOVE FAILED: @msg',
        ['@msg' => $e->getMessage()]
      );

      // Fallback: at least update the filename field.
      $file->setFilename($sanitized_filename);
    }

    \Drupal::logger('file_sanitizer')->notice(
      '=== FILE_PRESAVE END (temporary) === Final: filename="@filename" | uri="@uri"',
      [
        '@filename' => $file->getFilename(),
        '@uri' => $file->getFileUri(),
      ]
    );

    return;
  }

  // For non-temporary files (rare but possible), rename in place.
  $old_uri = $file->getFileUri();
  $directory = dirname($old_uri);
  $new_uri = $directory . '/' . $sanitized_filename;

  \Drupal::logger('file_sanitizer')->notice(
    'NON-TEMPORARY FILE: old_uri="@old" | directory="@dir" | new_uri="@new"',
    [
      '@old' => $old_uri,
      '@dir' => $directory,
      '@new' => $new_uri,
    ]
  );

  try {
    $file_system = \Drupal::service('file_system');
    $final_uri = $file_system->move(
      $old_uri,
      $new_uri,
      FileExists::Rename
    );

    $file->setFilename(basename($final_uri));
    $file->setFileUri($final_uri);

    \Drupal::logger('file_sanitizer')->notice(
      'NON-TEMPORARY RENAMED: final_uri="@uri"',
      ['@uri' => $final_uri]
    );
  }
  catch (\Exception $e) {
    \Drupal::logger('file_sanitizer')->error(
      'NON-TEMPORARY RENAME FAILED: @msg',
      ['@msg' => $e->getMessage()]
    );

    // Fallback: at least update the filename field.
    $file->setFilename($sanitized_filename);
  }

  \Drupal::logger('file_sanitizer')->notice(
    '=== FILE_PRESAVE END (non-temporary) === Final: filename="@filename" | uri="@uri"',
    [
      '@filename' => $file->getFilename(),
      '@uri' => $file->getFileUri(),
    ]
  );
}
