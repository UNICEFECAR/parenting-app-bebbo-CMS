<?php

/**
 * @file
 * It contains group field module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\views\ViewExecutable;
use Drupal\user\Entity\Role;

/**
 * Implements form alter.
 */
function group_country_field_form_alter(array &$form, FormStateInterface $form_state, $form_id) {

  if ($form['#id'] == "tmgmt-job-item-edit-form") {
    $user = \Drupal::currentUser();
    $user_roles = $user->getRoles();

    if (in_array('administrator', $user_roles) !== TRUE) {

      // Batch load all roles at once instead of loading in a loop.
      $roles = Role::loadMultiple($user_roles);
      $roles_permissions = [];
      foreach ($roles as $role_id => $role) {
        $roles_permissions[$role_id] = $role->getPermissions();
      }

      $new_default_state = ["review_after_translation" => "Review_after_translation"];
      if (!empty($roles_permissions['global_admin'])) {
        if (in_array("administer nodes", $roles_permissions['global_admin'])) {
          $form['moderation_state']['new_state']['#options'] = $form['moderation_state']['new_state']['#options'];
        }
      }
      elseif (!empty($roles_permissions['editor'])) {
        $new_default_state = ["review_after_translation" => "Review_after_translation", "draft" => "Draft"];
        $form['moderation_state']['new_state']['#options'] = $new_default_state;
      }
      else {
        $form['moderation_state']['new_state']['#options'] = $new_default_state;
      }

    }
  }
}

/**
 * Implements views query alter.
 */
function group_country_field_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() == "recent_logged_in_users") {
    $user = \Drupal::currentUser();

    // Use cached group membership lookup.
    $grps = _group_country_field_get_user_groups_cached($user);

    $groups = [];
    foreach ($grps as $grp) {
      $groups[] = $grp->getGroup();
    }
    if (!empty($groups)) {
      $title = $groups[0]->label();
      // @phpstan-ignore-next-line
      foreach ($query->where as &$condition_group) {
        foreach ($condition_group['conditions'] as &$condition) {
          if ($condition['field'] == "groups_field_data_group_content_field_data.label") {
            $condition['value'] = $title;
          }
        }
      }
    }
  }
}

/**
 * Get user's group memberships with caching.
 *
 * @param \Drupal\Core\Session\AccountInterface $user
 *   The user account.
 *
 * @return array
 *   Array of group memberships.
 */
function _group_country_field_get_user_groups_cached(AccountInterface $user) {
  // Use static cache for within-request caching.
  $cache = &drupal_static(__FUNCTION__, []);
  $uid = $user->id();

  if (isset($cache[$uid])) {
    return $cache[$uid];
  }

  // Check persistent cache.
  $cid = 'group_country_field:user_groups:' . $uid;
  $cache_backend = \Drupal::cache();
  $cached = $cache_backend->get($cid);

  if ($cached && $cached->data) {
    $cache[$uid] = $cached->data;
    return $cache[$uid];
  }

  // Load from service.
  $membership_loader = \Drupal::service('group.membership_loader');
  $grps = $membership_loader->loadByUser($user);

  // Cache for 5 minutes with user cache tag.
  $cache_backend->set($cid, $grps, \Drupal::time()->getRequestTime() + 300, ['user:' . $uid]);
  $cache[$uid] = $grps;

  return $grps;
}

/**
 * Implements views form alter.
 *
 * Translation job items item id size.
 */
function group_country_field_form_views_exposed_form_alter(&$form, $form_state) {
  if ($form['#id'] == 'views-exposed-form-tmgmt-translation-all-job-items-page-1') {
    $form['item_id']['#size'] = 5;
  }
  if ($form['#id'] == 'views-exposed-form-country-reports-page-5' || $form['#id'] == 'views-exposed-form-global-reports-page-4') {
    $form['created']['min']['#title'] = t('Created From');
    $form['created']['max']['#title'] = t('Created To');
    $form['changed']['min']['#title'] = t('Updated From');
    $form['changed']['max']['#title'] = t('Updated To');
  }
}
